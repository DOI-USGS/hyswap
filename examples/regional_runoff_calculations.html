<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Using hyswap to estimate runoff for one and multiple HUC08s &mdash; hyswap 0.1.dev1+gfaa6328 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=19f00094" />
      <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../_static/nbsphinx-code-cells.css?v=2aa19091" />

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script src="../_static/jquery.js?v=5d32c60e"></script>
        <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
        <script src="../_static/documentation_options.js?v=b50ea131"></script>
        <script src="../_static/doctools.js?v=9a2dae69"></script>
        <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
        <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Glossary" href="../meta/glossary.html" />
    <link rel="prev" title="Visualization of Streamflow Conditions at Streamgages" href="site_conditions_examples.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            hyswap
          </a>
              <div class="version">
                0.1
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../meta/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Simple Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html#example-workflow-notebooks">Example Workflow Notebooks</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="single_gage_analysis.html">Analysis of Streamflow Conditions and Historical Streamflows at a Single Gage</a></li>
<li class="toctree-l2"><a class="reference internal" href="single_gage_n_day_flows_analysis.html">Analysis of Streamflow N-Day Averages for a Single Gage</a></li>
<li class="toctree-l2"><a class="reference internal" href="site_conditions_examples.html">Visualization of Streamflow Conditions at Streamgages</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Using hyswap to estimate runoff for one and multiple HUC08s</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#Read-in-huc-basin-intersection-table">Read in huc-basin intersection table</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Select-watershed-to-estimate-runoff">Select watershed to estimate runoff</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Custom-function-for-grabbing-gage-flow-data-from-dataretrieval-and-converting-it-to-runoff">Custom function for grabbing gage flow data from <code class="docutils literal notranslate"><span class="pre">dataretrieval</span></code> and converting it to runoff</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Download-gage-data">Download gage data</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Estimate-runoff-for-the-huc">Estimate runoff for the huc</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Estimate-runoff-for-all-hucs">Estimate runoff for all hucs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#Mapping-the-results-of-the-runoff-calculation">Mapping the results of the runoff calculation</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../meta/glossary.html">Glossary</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meta/calculations.html">Calculations Quick-Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meta/contributing.html">Contributing Guidelines</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meta/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../meta/disclaimer.html#license">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">Module Dependency Graph</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html#api-reference">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">hyswap</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="index.html">Simple Examples</a></li>
      <li class="breadcrumb-item active">Using hyswap to estimate runoff for one and multiple HUC08s</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/examples/regional_runoff_calculations.nblink.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="Using-hyswap-to-estimate-runoff-for-one-and-multiple-HUC08s">
<h1>Using hyswap to estimate runoff for one and multiple HUC08s<a class="headerlink" href="#Using-hyswap-to-estimate-runoff-for-one-and-multiple-HUC08s" title="Link to this heading"></a></h1>
<p>This notebook demonstrates how to use the <a class="reference external" href="https://doi-usgs.github.io/hyswap/">hyswap</a> python package to estimate runoff over 10 water years (2013-2023) for a set of hydrologic units using streamflow measured at gages that overlap with the hydrologic units of interest.</p>
<p>This example notebook relies on use of the <a class="reference external" href="https://github.com/DOI-USGS/dataRetrieval">dataretrieval</a> package for downloading streamflow information from USGS NWIS.</p>
<p>Hydrologic units will be referred to as “hucs” and the drainage area captured by a streamflow gage will be referred to as a “basin”.</p>
<p>Please note that warnings in this notebook have been silenced to economize space in the documentation pages, but it is recommended to comment out this line for individual use.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">dataretrieval</span>
<span class="kn">import</span> <span class="nn">hyswap</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span>
<span class="kn">from</span> <span class="nn">pynhd</span> <span class="kn">import</span> <span class="n">WaterData</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="c1"># temporary workaround for hyriver issue</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;HYRIVER_CACHE_DISABLE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;true&quot;</span>
</pre></div>
</div>
</div>
<section id="Read-in-huc-basin-intersection-table">
<h2>Read in huc-basin intersection table<a class="headerlink" href="#Read-in-huc-basin-intersection-table" title="Link to this heading"></a></h2>
<p>The huc-basin intersection dataset is created using shapefiles for hucs and site drainage basins, and is the output of the <a class="reference external" href="https://code.usgs.gov/water/computational-tools/surface-water-work/hyswap-geospatial-data-assembly">hyswap geospatial data assembly repository</a> . For each huc-basin intersection, it contains the proportion of the huc’s area in the basin, and the proportion of the basin’s area in the huc. You can find this file in the ‘example_data’ folder within the ‘example_notebooks’
folder in the <code class="docutils literal notranslate"><span class="pre">hyswap</span></code> repository.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#| tbl-cap: The top rows of the intersection table created by the hyswap geospatial data assembly repository</span>
<span class="c1"># This example initially reads in the entire huc_basin_intersection table.</span>
<span class="n">intersection_table_full</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s1">&#39;example_data/huc_props_tbl_conus.csv&#39;</span><span class="p">,</span>
                             <span class="n">converters</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="mi">1</span><span class="p">:</span><span class="nb">str</span><span class="p">,</span><span class="mi">2</span><span class="p">:</span><span class="nb">str</span><span class="p">}</span>
                             <span class="p">)</span>

<span class="c1"># drop first col that is the index from the csv.</span>
<span class="n">intersection_table_full</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="n">intersection_table_full</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span>
<span class="p">)</span>
<span class="c1"># view</span>
<span class="n">intersection_table_full</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Select-watershed-to-estimate-runoff">
<h2>Select watershed to estimate runoff<a class="headerlink" href="#Select-watershed-to-estimate-runoff" title="Link to this heading"></a></h2>
<p>This example focuses on a bounding box of HUC08’s in Montana and Idaho. We will first filter to one of the hucs to show how to estimate runoff for a single huc, but later on we will estimate runoff for all hucs in the dataset. We will also establish the start and end dates over which we’d like to estimate runoff.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">huc_shapes</span> <span class="o">=</span> <span class="n">WaterData</span><span class="p">(</span><span class="s1">&#39;huc08&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">bybox</span><span class="p">([</span><span class="o">-</span><span class="mf">115.065380</span><span class="p">,</span> <span class="mf">45.947037</span><span class="p">,</span> <span class="o">-</span><span class="mf">112.692334</span><span class="p">,</span> <span class="mf">47.572536</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#| tbl-cap: The first few rows of the geopandas dataframe from `pynhd`</span>
<span class="n">huc_shapes</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#| fig-cap: &#39;A map of the single HUC08, 17010209&#39;</span>
<span class="n">single_huc</span> <span class="o">=</span> <span class="n">huc_shapes</span><span class="p">[</span><span class="s1">&#39;huc8&#39;</span><span class="p">][</span><span class="mi">9</span><span class="p">]</span>

<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2012-10-01&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2023-09-30&#39;</span>

<span class="n">huc_shapes</span><span class="p">[</span><span class="n">huc_shapes</span><span class="p">[</span><span class="s1">&#39;huc8&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">single_huc</span><span class="p">]</span><span class="o">.</span><span class="n">explore</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>If we wanted to estimate runoff for one huc, we would first identify which basins intersect the huc using the <code class="docutils literal notranslate"><span class="pre">identify_sites_from_geom_intersection</span></code> function. From this list of basins, we would then download their corresponding gage streamflow data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Pull basin site ids from selected huc8 geom using the hyswap runoff identify sites from geom intersection function</span>
<span class="n">basins_overlap_single_huc</span> <span class="o">=</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">runoff</span><span class="o">.</span><span class="n">identify_sites_from_geom_intersection</span><span class="p">(</span><span class="n">geom_id</span> <span class="o">=</span> <span class="n">single_huc</span><span class="p">,</span>
                                   <span class="n">geom_intersection_df</span> <span class="o">=</span> <span class="n">intersection_table_full</span><span class="p">,</span>
                                   <span class="n">geom_id_column_name</span><span class="o">=</span><span class="s1">&#39;huc_id&#39;</span><span class="p">,</span>
                                   <span class="n">site_column_name</span><span class="o">=</span><span class="s1">&#39;da_site_no&#39;</span><span class="p">,</span>
                                   <span class="n">prop_geom_in_basin_col</span><span class="o">=</span><span class="s1">&#39;prop_huc_in_basin&#39;</span><span class="p">,</span>
                                   <span class="n">prop_basin_in_geom_col</span><span class="o">=</span><span class="s1">&#39;prop_basin_in_huc&#39;</span>
                                   <span class="p">)</span>

<span class="c1"># output should be long list of sites ids. These are all the site_ids within the selected huc8 polygon</span>
<span class="n">num_sites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">basins_overlap_single_huc</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;There are </span><span class="si">{</span><span class="n">num_sites</span><span class="si">}</span><span class="s1"> gaged basins that overlap this huc.&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Custom-function-for-grabbing-gage-flow-data-from-dataretrieval-and-converting-it-to-runoff">
<h2>Custom function for grabbing gage flow data from <code class="docutils literal notranslate"><span class="pre">dataretrieval</span></code> and converting it to runoff<a class="headerlink" href="#Custom-function-for-grabbing-gage-flow-data-from-dataretrieval-and-converting-it-to-runoff" title="Link to this heading"></a></h2>
<p>To estimate runoff for a huc, we need to create a dictionary of runoff data, where each key corresponds to a site id for a basin, and the item is a dataframe with a datetime index and runoff values for that site in a ‘runoff’ column. The function below leverages <code class="docutils literal notranslate"><span class="pre">dataretrieval</span></code> to pull streamflow data for a set of input sites over a specified date range, and then uses <code class="docutils literal notranslate"><span class="pre">hyswap</span></code>’s <code class="docutils literal notranslate"><span class="pre">streamflow_to_runoff</span></code> function in the <code class="docutils literal notranslate"><span class="pre">runoff</span></code> module to estimate area-based runoff using site drainage
areas. It produces runoff values in millimeters per day. Note that this function can take some time, depending upon the size/number of queries. Additionally, it is not unusual for many sites to return no data.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">query_nwis_runoff_data</span><span class="p">(</span><span class="n">sites</span><span class="p">,</span>
    <span class="n">start_date</span><span class="p">,</span>
    <span class="n">end_date</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pulling site streamflow data and converting it to runoff. This may take some time...&quot;</span><span class="p">)</span>
    <span class="c1"># first, pull site info</span>
    <span class="n">info_df</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">dataretrieval</span><span class="o">.</span><span class="n">nwis</span><span class="o">.</span><span class="n">get_info</span><span class="p">(</span><span class="n">sites</span><span class="o">=</span><span class="n">sites</span><span class="p">)</span>
    <span class="c1"># convert drainage area from sq mi to sq km</span>
    <span class="n">info_df</span><span class="p">[</span><span class="s1">&#39;da&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">info_df</span><span class="p">[</span><span class="s1">&#39;drain_area_va&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.58998811</span>
    <span class="c1"># info_df = info_df[[&#39;da&#39;, &#39;site_no&#39;]]</span>
    <span class="c1"># get streamflow data between start and end date</span>
    <span class="n">dv_df</span> <span class="o">=</span> <span class="n">dataretrieval</span><span class="o">.</span><span class="n">nwis</span><span class="o">.</span><span class="n">get_record</span><span class="p">(</span>
        <span class="n">sites</span><span class="o">=</span><span class="n">sites</span><span class="p">,</span> <span class="n">parameterCd</span><span class="o">=</span><span class="s1">&#39;00060&#39;</span><span class="p">,</span>
        <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">,</span>
        <span class="n">multi_index</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">service</span><span class="o">=</span><span class="s1">&#39;dv&#39;</span>
        <span class="p">)</span>
    <span class="n">df_nwis_ro_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dv_df</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
        <span class="c1"># get site ids from dv_df and create empty</span>
        <span class="c1"># df to hold site runoff data</span>
        <span class="n">siteids</span> <span class="o">=</span> <span class="n">dv_df</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="c1"># Loop through sites retrieved from nwis and estimate</span>
        <span class="c1"># runoff using hyswap function</span>
        <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="n">siteids</span><span class="p">:</span>
            <span class="n">ro_df</span> <span class="o">=</span> <span class="n">dv_df</span><span class="p">[</span><span class="n">dv_df</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">site</span><span class="p">]</span>
            <span class="n">da</span> <span class="o">=</span> <span class="n">info_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">info_df</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">]</span><span class="o">==</span><span class="n">site</span><span class="p">][</span><span class="s1">&#39;da&#39;</span><span class="p">]</span>
            <span class="n">ro_df</span> <span class="o">=</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">runoff</span><span class="o">.</span><span class="n">streamflow_to_runoff</span><span class="p">(</span><span class="n">ro_df</span><span class="p">,</span> <span class="s1">&#39;00060_Mean&#39;</span><span class="p">,</span> <span class="n">da</span><span class="p">,</span> <span class="n">time_unit</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">)</span>
            <span class="n">df_nwis_ro_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_nwis_ro_data</span><span class="p">,</span> <span class="n">ro_df</span><span class="p">])</span>
        <span class="c1"># print proportion of sites with data</span>
        <span class="n">prop</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">siteids</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Prop of successful nwis queries from list of sites:</span><span class="se">\n</span><span class="s1"> </span><span class="si">{</span><span class="n">prop</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No site data available, returning empty dataframe&quot;</span><span class="p">)</span>

    <span class="k">return</span><span class="p">(</span><span class="n">df_nwis_ro_data</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Download-gage-data">
<h2>Download gage data<a class="headerlink" href="#Download-gage-data" title="Link to this heading"></a></h2>
<p>Let’s try using <code class="docutils literal notranslate"><span class="pre">query_nwis_runoff_data</span></code> to download streamflow data and convert it to runoff (in mm/day) from 2013-2023 for our selected huc ‘17010209’. Note that not all gage sites listed in <code class="docutils literal notranslate"><span class="pre">basins_overlap_single_huc</span></code> will necessarily have data for the date range specified.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">df_nwis_ro_data</span> <span class="o">=</span> <span class="n">query_nwis_runoff_data</span><span class="p">(</span><span class="n">basins_overlap_single_huc</span><span class="p">,</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="n">start_date</span><span class="p">,</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="n">end_date</span><span class="p">)</span>
<span class="n">df_nwis_ro_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Estimate-runoff-for-the-huc">
<h2>Estimate runoff for the huc<a class="headerlink" href="#Estimate-runoff-for-the-huc" title="Link to this heading"></a></h2>
<p>With daily basin runoff data in hand, we are ready to estimate runoff for the huc in mm/day. Please reference <code class="docutils literal notranslate"><span class="pre">hyswap</span></code>’s <a class="reference external" href="https://doi-usgs.github.io/hyswap/meta/calculations.html">Calculations</a> page to understand how runoff is estimated using this function. Briefly, this function identifies basins contained within the huc and basins that contain the huc that have runoff data for the entire time period in the dataset. It then estimates a weighted mean runoff value for each day using
applicable and available basins. If <code class="docutils literal notranslate"><span class="pre">clip_downstream_basins</span></code> is set to True, the function only uses the smallest basin that contains the huc and disregards downstream gages that represent larger basins that contain the huc. This example will loop through each water year and estimate runoff using basins with complete records for each water year.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># get water year in dataset so can loop by water year to estimate runoff</span>
<span class="n">df_nwis_ro_data</span><span class="p">[</span><span class="s1">&#39;water_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nwis_ro_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
<span class="n">df_nwis_ro_data</span><span class="p">[</span><span class="s1">&#39;water_year&#39;</span><span class="p">][</span><span class="n">df_nwis_ro_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nwis_ro_data</span><span class="p">[</span><span class="s1">&#39;water_year&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># create df to hold estimate results</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

    <span class="c1"># loop through each water year</span>
<span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">df_year</span> <span class="ow">in</span> <span class="n">df_nwis_ro_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df_nwis_ro_data</span><span class="o">.</span><span class="n">water_year</span><span class="p">):</span>

    <span class="c1"># estimate runoff for each water year of data</span>
    <span class="n">single_huc_runoff</span> <span class="o">=</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">calculate_geometric_runoff</span><span class="p">(</span>
        <span class="n">geom_id</span><span class="o">=</span><span class="n">single_huc</span><span class="p">,</span>
        <span class="n">runoff_df</span><span class="o">=</span><span class="n">df_year</span><span class="p">,</span>
        <span class="n">geom_intersection_df</span><span class="o">=</span><span class="n">intersection_table_full</span><span class="p">,</span>
        <span class="n">site_column_name</span><span class="o">=</span><span class="s1">&#39;da_site_no&#39;</span><span class="p">,</span>
        <span class="n">geom_id_column_name</span><span class="o">=</span><span class="s1">&#39;huc_id&#39;</span><span class="p">,</span>
        <span class="n">prop_geom_in_basin_col</span><span class="o">=</span><span class="s1">&#39;prop_huc_in_basin&#39;</span><span class="p">,</span>
        <span class="n">prop_basin_in_geom_col</span><span class="o">=</span><span class="s1">&#39;prop_basin_in_huc&#39;</span><span class="p">,</span>
        <span class="n">percentage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">clip_downstream_basins</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">full_overlap_threshold</span><span class="o">=</span><span class="mf">0.98</span>
        <span class="p">)</span>

                <span class="c1"># concatenate with previous years runoffs</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">results</span><span class="p">,</span> <span class="n">single_huc_runoff</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Let’s take a quick look at the estimated runoff.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#| fig-cap: A runoff hydrograph for huc 17010209 using the `hyswap.plot_hydrograph` function</span>
<span class="n">hyswap</span><span class="o">.</span><span class="n">plot_hydrograph</span><span class="p">(</span>
    <span class="n">results</span><span class="p">,</span>
    <span class="n">data_column_name</span><span class="o">=</span><span class="s1">&#39;estimated_runoff&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="sa">f</span><span class="s1">&#39;Estimated Runoff for HUC </span><span class="si">{</span><span class="n">single_huc</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
    <span class="n">yscale</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span>
    <span class="n">ylab</span><span class="o">=</span><span class="s1">&#39;Runoff (mm)&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Estimate-runoff-for-all-hucs">
<h2>Estimate runoff for all hucs<a class="headerlink" href="#Estimate-runoff-for-all-hucs" title="Link to this heading"></a></h2>
<p>Now, we will estimate runoff for all of the hucs in the region selected. First, we’ll identify the sites with drainage basins that intersect the seven hucs. Next, we’ll need to use our custom function to download flow data and estimate runoff for each basin. Finally, we can leverage <code class="docutils literal notranslate"><span class="pre">hyswap</span></code>’s <code class="docutils literal notranslate"><span class="pre">calculate_multiple_geometric_runoff</span></code>, which loops through a list of hucs, finds their intersecting gage basins, and estimates runoff for each day in the dataset. Note that by setting the
<code class="docutils literal notranslate"><span class="pre">clip_downstream_basins</span></code> argument to True, the function is only considering basins within each HUC08 and the smallest basin containing each HUC08 in the runoff estimate.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">list_site_ids</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1"># loop through to get all sites (identify_sites_from_geom_intersection() cannot accept multiple geom_ids)</span>
<span class="k">for</span> <span class="n">huc</span> <span class="ow">in</span> <span class="n">huc_shapes</span><span class="p">[</span><span class="s1">&#39;huc8&#39;</span><span class="p">]:</span>
    <span class="n">sites</span> <span class="o">=</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">runoff</span><span class="o">.</span><span class="n">identify_sites_from_geom_intersection</span><span class="p">(</span>
        <span class="n">geom_id</span> <span class="o">=</span> <span class="n">huc</span><span class="p">,</span>
        <span class="n">geom_intersection_df</span> <span class="o">=</span> <span class="n">intersection_table_full</span><span class="p">,</span>
        <span class="n">geom_id_column_name</span><span class="o">=</span><span class="s1">&#39;huc_id&#39;</span><span class="p">,</span>
        <span class="n">site_column_name</span><span class="o">=</span><span class="s1">&#39;da_site_no&#39;</span><span class="p">,</span>
        <span class="n">prop_geom_in_basin_col</span><span class="o">=</span><span class="s1">&#39;prop_huc_in_basin&#39;</span><span class="p">,</span>
        <span class="n">prop_basin_in_geom_col</span><span class="o">=</span><span class="s1">&#39;prop_basin_in_huc&#39;</span>
        <span class="p">)</span>

    <span class="n">list_site_ids</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sites</span><span class="p">)</span>

<span class="c1"># join list of lists, as for loop above separates out the list of dfs</span>
<span class="n">all_site_ids</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">list_site_ids</span><span class="p">,[])</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># grab basin data using the all_site_ids list</span>
<span class="n">df_nwis_ro_data</span> <span class="o">=</span> <span class="n">query_nwis_runoff_data</span><span class="p">(</span><span class="n">all_site_ids</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span>
<span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="c1"># get water year in dataset so can loop by water year to estimate runoff</span>
<span class="n">df_nwis_ro_data</span><span class="p">[</span><span class="s1">&#39;water_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nwis_ro_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
<span class="n">df_nwis_ro_data</span><span class="p">[</span><span class="s1">&#39;water_year&#39;</span><span class="p">][</span><span class="n">df_nwis_ro_data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_nwis_ro_data</span><span class="p">[</span><span class="s1">&#39;water_year&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1"># create df to hold estimate results</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="c1"># loop through each water year</span>
<span class="k">for</span> <span class="n">year</span><span class="p">,</span> <span class="n">df_year</span> <span class="ow">in</span> <span class="n">df_nwis_ro_data</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">df_nwis_ro_data</span><span class="o">.</span><span class="n">water_year</span><span class="p">):</span>
    <span class="c1"># subset data to water year</span>
    <span class="n">df_nwis_ro_data_sub</span> <span class="o">=</span> <span class="n">df_nwis_ro_data</span><span class="p">[</span><span class="n">df_nwis_ro_data</span><span class="p">[</span><span class="s1">&#39;water_year&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">year</span><span class="p">]</span>

    <span class="n">multiple_huc_runoff</span> <span class="o">=</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">runoff</span><span class="o">.</span><span class="n">calculate_multiple_geometric_runoff</span><span class="p">(</span>
        <span class="n">geom_id_list</span> <span class="o">=</span> <span class="n">huc_shapes</span><span class="p">[</span><span class="s1">&#39;huc8&#39;</span><span class="p">],</span>
        <span class="n">runoff_df</span> <span class="o">=</span> <span class="n">df_nwis_ro_data</span><span class="p">,</span>
        <span class="n">geom_intersection_df</span><span class="o">=</span><span class="n">intersection_table_full</span><span class="p">,</span>
        <span class="n">site_column_name</span><span class="o">=</span><span class="s1">&#39;da_site_no&#39;</span><span class="p">,</span>
        <span class="n">geom_id_column_name</span><span class="o">=</span><span class="s1">&#39;huc_id&#39;</span><span class="p">,</span>
        <span class="n">prop_geom_in_basin_col</span><span class="o">=</span> <span class="s1">&#39;prop_huc_in_basin&#39;</span><span class="p">,</span>
        <span class="n">prop_basin_in_geom_col</span><span class="o">=</span><span class="s1">&#39;prop_basin_in_huc&#39;</span><span class="p">,</span>
        <span class="n">percentage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">clip_downstream_basins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">full_overlap_threshold</span><span class="o">=</span><span class="mf">0.98</span>
        <span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">results</span><span class="p">,</span> <span class="n">multiple_huc_runoff</span><span class="p">])</span>
</pre></div>
</div>
</div>
<p>Like our single huc runoff calculation, we can take a look at the estimated runoff across multiple hucs. Because there are 16 HUCs in this dataset, we will only plot a subset below using the <code class="docutils literal notranslate"><span class="pre">pivot_table</span></code> function from <code class="docutils literal notranslate"><span class="pre">pandas</span></code>.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#| fig-cap: A multiple runoff hydrograph for all hucs pulled from `pynhd` in this example</span>
<span class="c1"># Plot</span>
<span class="n">results_plot</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pivot_table</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">results</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="s1">&#39;geom_id&#39;</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="s1">&#39;estimated_runoff&#39;</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">results_plot</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="mi">10</span><span class="p">:</span><span class="mi">14</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Runoff (mm)&quot;</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s1">&#39;HUC ID&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
</section>
<section id="Mapping-the-results-of-the-runoff-calculation">
<h2>Mapping the results of the runoff calculation<a class="headerlink" href="#Mapping-the-results-of-the-runoff-calculation" title="Link to this heading"></a></h2>
<p>In this step of the analysis, we will estimate variable percentiles by day for each huc, and then use those percentiles to estimate a percentile for a new estimated runoff value. We will then plot these percentiles in a map of the hucs.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">huc_ids</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;geom_id&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span>

<span class="n">percentile_results</span> <span class="o">=</span> <span class="p">{}</span>

<span class="k">for</span> <span class="n">huc_id</span> <span class="ow">in</span> <span class="n">huc_ids</span><span class="p">:</span>
    <span class="n">results_sub</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">&#39;geom_id&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">huc_id</span><span class="p">]</span>
    <span class="n">results_sub</span><span class="o">.</span><span class="n">sort_index</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">percentiles</span> <span class="o">=</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">calculate_variable_percentile_thresholds_by_day</span><span class="p">(</span><span class="n">results_sub</span><span class="p">,</span>
                                                                         <span class="n">data_column_name</span><span class="o">=</span><span class="s1">&#39;estimated_runoff&#39;</span><span class="p">)</span>
    <span class="n">percentile_results</span><span class="p">[</span><span class="n">huc_id</span><span class="p">]</span> <span class="o">=</span> <span class="n">percentiles</span>
</pre></div>
</div>
</div>
<p>Now, we will pull a new set of gage streamflow data for the first day of the next water year, and estimate runoff.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%capture</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s1">&#39;2023-10-01&#39;</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s1">&#39;2023-10-01&#39;</span>
<span class="c1"># grab basin data using the all_site_ids list</span>
<span class="n">df_nwis_ro_data_new</span> <span class="o">=</span> <span class="n">query_nwis_runoff_data</span><span class="p">(</span><span class="n">all_site_ids</span><span class="p">,</span> <span class="n">start_date</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end_date</span><span class="o">=</span><span class="n">end_date</span><span class="p">)</span>

<span class="n">multiple_huc_runoff_new</span> <span class="o">=</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">runoff</span><span class="o">.</span><span class="n">calculate_multiple_geometric_runoff</span><span class="p">(</span>
    <span class="n">geom_id_list</span> <span class="o">=</span> <span class="n">huc_shapes</span><span class="p">[</span><span class="s1">&#39;huc8&#39;</span><span class="p">],</span>
    <span class="n">runoff_df</span> <span class="o">=</span> <span class="n">df_nwis_ro_data_new</span><span class="p">,</span>
    <span class="n">geom_intersection_df</span><span class="o">=</span><span class="n">intersection_table_full</span><span class="p">,</span>
    <span class="n">site_column_name</span><span class="o">=</span><span class="s1">&#39;da_site_no&#39;</span><span class="p">,</span>
    <span class="n">geom_id_column_name</span><span class="o">=</span><span class="s1">&#39;huc_id&#39;</span><span class="p">,</span>
    <span class="n">prop_geom_in_basin_col</span><span class="o">=</span> <span class="s1">&#39;prop_huc_in_basin&#39;</span><span class="p">,</span>
    <span class="n">prop_basin_in_geom_col</span><span class="o">=</span><span class="s1">&#39;prop_basin_in_huc&#39;</span><span class="p">,</span>
    <span class="n">percentage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">clip_downstream_basins</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">full_overlap_threshold</span><span class="o">=</span><span class="mf">0.98</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<p>With runoff in hand, we can then calculate the percentile for this date for each HUC08, based on the percentiles we calculated for the previous 5-year period.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Calculate estimated streamflow percentile for the new data by interpolating against</span>
<span class="c1"># the previously calculated percentile threshold levels</span>
<span class="n">huc_perc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>

<span class="k">for</span> <span class="n">huc</span><span class="p">,</span> <span class="n">huc_df</span> <span class="ow">in</span> <span class="n">multiple_huc_runoff_new</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;geom_id&#39;</span><span class="p">,</span> <span class="n">group_keys</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">huc_perc_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">huc_perc_df</span><span class="p">,</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">percentiles</span><span class="o">.</span><span class="n">calculate_multiple_variable_percentiles_from_values</span><span class="p">(</span>
            <span class="n">huc_df</span><span class="p">,</span><span class="s1">&#39;estimated_runoff&#39;</span><span class="p">,</span> <span class="n">percentile_results</span><span class="p">[</span><span class="n">huc</span><span class="p">])])</span>
<span class="c1"># categorize streamflow by the estimated streamflow percentiles</span>
<span class="n">huc_perc_df</span> <span class="o">=</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">categorize_flows</span><span class="p">(</span><span class="n">huc_perc_df</span><span class="p">,</span> <span class="s1">&#39;est_pct&#39;</span><span class="p">,</span> <span class="n">schema_name</span><span class="o">=</span><span class="s2">&quot;NWD&quot;</span><span class="p">)</span>
<span class="n">huc_perc_df</span> <span class="o">=</span> <span class="n">huc_perc_df</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="s1">&#39;datetime&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>And finally, create an interactive map showing HUC08 runoff percentiles for October 1, 2023.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[ ]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#| fig-cap: &#39;HUC08 colors correspond to the runoff percentiles for 10-01-2023 flow based on 5 years of estimated runoff data at the HUC08 scale, derived from gage basin flow data.&#39;</span>
<span class="c1"># merge percentile information to geodataframe with polygon geometry</span>
<span class="n">huc_shapes_percs</span> <span class="o">=</span> <span class="n">huc_shapes</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">huc_perc_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;geom_id&#39;</span><span class="p">),</span> <span class="n">left_on</span><span class="o">=</span><span class="s1">&#39;huc8&#39;</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="c1"># set up gdf format for plotting - ex. get rid of datetimes/timestamps</span>
<span class="n">huc_shapes_percs</span><span class="p">[</span><span class="s1">&#39;Date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">huc_shapes_percs</span><span class="p">[</span><span class="s1">&#39;datetime&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1"> %H:%M&#39;</span><span class="p">)</span>
<span class="n">schema</span> <span class="o">=</span> <span class="n">hyswap</span><span class="o">.</span><span class="n">utils</span><span class="o">.</span><span class="n">retrieve_schema</span><span class="p">(</span><span class="s1">&#39;NWD&#39;</span><span class="p">)</span>
<span class="n">flow_cond_cmap</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;colors&#39;</span><span class="p">]</span>
<span class="k">if</span> <span class="s1">&#39;low_color&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
                <span class="n">flow_cond_cmap</span> <span class="o">=</span> <span class="p">[</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;low_color&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="n">flow_cond_cmap</span>
<span class="k">if</span> <span class="s1">&#39;high_color&#39;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
                <span class="n">flow_cond_cmap</span> <span class="o">=</span> <span class="n">flow_cond_cmap</span> <span class="o">+</span> <span class="p">[</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;high_color&#39;</span><span class="p">]]</span>
<span class="c1"># set NA values to &quot;Not Ranked&quot; category</span>
<span class="n">huc_shapes_percs</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">huc_shapes_percs</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="s1">&#39;Not Ranked&#39;</span><span class="p">)</span>
<span class="n">huc_shapes_percs</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">huc_shapes_percs</span><span class="p">[</span><span class="s1">&#39;est_pct&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">(),</span> <span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;Not Ranked&#39;</span>
<span class="n">flow_cond_cmap</span> <span class="o">=</span> <span class="n">flow_cond_cmap</span> <span class="o">+</span> <span class="p">[</span><span class="s1">&#39;#d3d3d3&#39;</span><span class="p">]</span> <span class="c1"># light grey</span>
<span class="c1"># renaming columns with user friendly names for map</span>
<span class="n">huc_shapes_percs</span> <span class="o">=</span> <span class="n">huc_shapes_percs</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s1">&#39;loaddate&#39;</span><span class="p">,</span> <span class="s1">&#39;datetime&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">huc_shapes_percs</span> <span class="o">=</span> <span class="n">huc_shapes_percs</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;estimated_runoff&#39;</span><span class="p">:</span><span class="s1">&#39;Runoff (mm/day)&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;est_pct&#39;</span><span class="p">:</span><span class="s1">&#39;Estimated Percentile&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;huc8&#39;</span><span class="p">:</span><span class="s1">&#39;HUC08 ID&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;HUC08 Name&#39;</span><span class="p">,</span>
                                                <span class="s1">&#39;flow_cat&#39;</span><span class="p">:</span><span class="s1">&#39;Streamflow Category&#39;</span><span class="p">})</span>
<span class="c1"># Create map of runoff</span>
<span class="n">huc_shapes_percs</span><span class="o">.</span><span class="n">explore</span><span class="p">(</span>
    <span class="n">column</span><span class="o">=</span><span class="s2">&quot;Streamflow Category&quot;</span><span class="p">,</span>
    <span class="n">cmap</span><span class="o">=</span><span class="n">flow_cond_cmap</span><span class="p">,</span>
    <span class="n">tooltip</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;HUC08 ID&quot;</span><span class="p">,</span> <span class="s1">&#39;HUC08 Name&#39;</span><span class="p">,</span><span class="s2">&quot;Streamflow Category&quot;</span><span class="p">,</span> <span class="s2">&quot;Runoff (mm/day)&quot;</span><span class="p">,</span> <span class="s2">&quot;Estimated Percentile&quot;</span><span class="p">,</span> <span class="s2">&quot;Date&quot;</span><span class="p">],</span>
    <span class="n">tiles</span><span class="o">=</span><span class="s2">&quot;CartoDB Positron&quot;</span><span class="p">,</span>
    <span class="n">marker_kwds</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">radius</span><span class="o">=</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">legend_kwds</span><span class="o">=</span><span class="nb">dict</span><span class="p">(</span><span class="n">caption</span><span class="o">=</span><span class="s1">&#39;Daily Mean Runoff Category&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="site_conditions_examples.html" class="btn btn-neutral float-left" title="Visualization of Streamflow Conditions at Streamgages" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../meta/glossary.html" class="btn btn-neutral float-right" title="Glossary" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>