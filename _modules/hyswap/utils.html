

<!doctype html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>hyswap.utils &#8212; hyswap 0.1.dev1+gaae8745 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
    <link rel="stylesheet" type="text/css" href="../../_static/bizstyle.css?v=f15d3b81" />
    <link rel="stylesheet" type="text/css" href="../../_static/plot_directive.css" />
    
    <script src="../../_static/documentation_options.js?v=993df700"></script>
    <script src="../../_static/doctools.js?v=888ff710"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/bizstyle.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <!--[if lt IE 9]>
    <script src="_static/css3-mediaqueries.js"></script>
    <![endif]-->
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">hyswap 0.1.dev1+gaae8745 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hyswap.utils</a></li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for hyswap.utils</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;Utility functions for hyswap.&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>


<div class="viewcode-block" id="filter_approved_data">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.filter_approved_data">[docs]</a>
<span class="k">def</span> <span class="nf">filter_approved_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filter_column</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter a dataframe to only return approved &quot;A&quot; (or &quot;A, e&quot;) data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : pandas.DataFrame</span>
<span class="sd">        The data to filter.</span>
<span class="sd">    filter_column : string</span>
<span class="sd">        The column upon which to filter. If None, an error will be raised.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        The filtered data.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Filter synthetic data to only return approved data. First make some</span>
<span class="sd">    synthetic data.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; df = pd.DataFrame({</span>
<span class="sd">        ...     &#39;data&#39;: [1, 2, 3, 4],</span>
<span class="sd">        ...     &#39;approved&#39;: [&#39;A&#39;, &#39;A&#39;, &#39;P&#39;, &#39;P&#39;]})</span>
<span class="sd">        &gt;&gt;&gt; df.shape</span>
<span class="sd">        (4, 2)</span>

<span class="sd">    Then filter the data to only return approved data.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; df = utils.filter_approved_data(df, filter_column=&#39;approved&#39;)</span>
<span class="sd">        &gt;&gt;&gt; df.shape</span>
<span class="sd">        (2, 2)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">filter_column</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;filter_column must be specified.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[((</span><span class="n">data</span><span class="p">[</span><span class="n">filter_column</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;A&quot;</span><span class="p">)</span> <span class="o">|</span>
                     <span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">filter_column</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;A, e&quot;</span><span class="p">))]</span></div>



<div class="viewcode-block" id="rolling_average">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.rolling_average">[docs]</a>
<span class="k">def</span> <span class="nf">rolling_average</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">data_column_name</span><span class="p">,</span> <span class="n">data_type</span><span class="p">,</span>
                    <span class="n">auto_min_periods</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">custom_min_periods</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate a rolling average for a dataframe.</span>

<span class="sd">    Default behavior right-aligns the window used for the rolling average</span>
<span class="sd">    and uses the data_type argument (&#39;1D&#39;, &#39;7D&#39;, &#39;14D&#39;, &#39;28D&#39;) to set the</span>
<span class="sd">    `min_periods` argument in `pandas.DataFrame.rolling`. The function</span>
<span class="sd">    returns NaN values if any of the values in the window are NaN or if the</span>
<span class="sd">    `mind_periods` argument is not satisifed. Properties of the windowing</span>
<span class="sd">    can be changed by passing additional keyword arguments which are fed</span>
<span class="sd">    to `pandas.DataFrame.rolling`.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        The dataframe to calculate the rolling average for.</span>
<span class="sd">    data_column_name : string</span>
<span class="sd">        The name of the column to calculate the rolling average for.</span>
<span class="sd">    data_type : string</span>
<span class="sd">        The formatted frequency string to be used with</span>
<span class="sd">        pandas.DataFrame.rolling to calculate the average over the correct</span>
<span class="sd">        temporal period.</span>
<span class="sd">    auto_min_periods : bool</span>
<span class="sd">        Defaults to True. When True, the `min_periods` argument in</span>
<span class="sd">        `pandas.DataFrame.rolling` is set using the `data_type` argument.</span>
<span class="sd">        For example, if the `data_type` = &#39;7D&#39;, the `min_periods`</span>
<span class="sd">        argument is 7. When False, the `min_periods` argument is set</span>
<span class="sd">        using the `custom_min_periods` input.</span>
<span class="sd">    custom_min_periods : int, optional</span>
<span class="sd">        Defaults to None. Only used if `auto_min_periods` is False.</span>
<span class="sd">        If `auto_min_periods` is False and an integer is provided,</span>
<span class="sd">        that integer will be used to define the `min_periods` argument</span>
<span class="sd">        in `pandas.DataFrame.rolling`.</span>
<span class="sd">    **kwargs</span>
<span class="sd">        Additional keyword arguments to be passed to</span>
<span class="sd">        `pandas.DataFrame.rolling`.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    pandas.DataFrame</span>
<span class="sd">        The output dataframe with the rolling average values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">auto_min_periods</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">min_periods</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_timedelta</span><span class="p">(</span><span class="n">data_type</span><span class="p">)</span><span class="o">.</span><span class="n">days</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">min_periods</span> <span class="o">=</span> <span class="n">custom_min_periods</span>
    <span class="n">df_out</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">df_out</span><span class="p">[</span><span class="n">data_column_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_out</span><span class="p">[</span><span class="n">data_column_name</span><span class="p">]</span><span class="o">.</span><span class="n">rolling</span><span class="p">(</span>
        <span class="n">data_type</span><span class="p">,</span>
        <span class="n">min_periods</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">df_out</span></div>



<div class="viewcode-block" id="filter_data_by_time">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.filter_data_by_time">[docs]</a>
<span class="k">def</span> <span class="nf">filter_data_by_time</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">data_column_name</span><span class="p">,</span> <span class="n">date_column_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                        <span class="n">time_interval</span><span class="o">=</span><span class="s1">&#39;day&#39;</span><span class="p">,</span>
                        <span class="n">leading_values</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">trailing_values</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="n">drop_na</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter data by some time interval.</span>

<span class="sd">    DataFrame containing data to filter. Expects datetime information to be</span>
<span class="sd">    available in the index or in a column named `date_column_name`. The</span>
<span class="sd">    returned `pandas.Series` object will have the datetimes for the specified</span>
<span class="sd">    time (day, month, year) as the index, and the corresponding data from the</span>
<span class="sd">    `data_column_name` column as the values.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    value : int</span>
<span class="sd">        Time value to use for filtering; value can be a day of year (1-366),</span>
<span class="sd">        month (1-12), or year (4 digit year).</span>

<span class="sd">    data_column_name : str</span>
<span class="sd">        Name of column containing data to filter.</span>

<span class="sd">    date_column_name : str, optional</span>
<span class="sd">        Name of column containing date information. If None, the index of</span>
<span class="sd">        `df` is used.</span>

<span class="sd">    time_interval : str, optional</span>
<span class="sd">        Time interval to filter by. Must be one of &#39;day&#39;, &#39;month&#39;, or &#39;year&#39;.</span>
<span class="sd">        Default is &#39;day&#39;.</span>

<span class="sd">    leading_values : int, optional</span>
<span class="sd">        Number of leading values to include in the output, inclusive.</span>
<span class="sd">        Default is 0, and parameter only applies to &#39;day&#39; time_interval.</span>

<span class="sd">    trailing_values : int, optional</span>
<span class="sd">        Number of trailing values to include in the output, inclusive.</span>
<span class="sd">        Default is 0, and parameter only applies to &#39;day&#39; time_interval.</span>

<span class="sd">    drop_na : bool, optional</span>
<span class="sd">        Drop NA values within filtered data</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data : pandas.Series</span>
<span class="sd">        Data from the specified day of year.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Filter some synthetic data by day of year. First make some synthetic data.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; df = pd.DataFrame({</span>
<span class="sd">        ...     &#39;data&#39;: [1, 2, 3, 4],</span>
<span class="sd">        ...     &#39;date&#39;: pd.date_range(&#39;2019-01-01&#39;, &#39;2019-01-04&#39;)})</span>
<span class="sd">        &gt;&gt;&gt; df.shape</span>
<span class="sd">        (4, 2)</span>

<span class="sd">    Then filter the data to get data from day 1.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; data = utils.filter_data_by_time(</span>
<span class="sd">        ...     df, 1, &#39;data&#39;, date_column_name=&#39;date&#39;)</span>
<span class="sd">        &gt;&gt;&gt; data.shape</span>
<span class="sd">        (1,)</span>

<span class="sd">    Acquire and filter some real daily data to get all Jan. 1 data.</span>

<span class="sd">    .. doctest::</span>
<span class="sd">        :skipif: True  # dataretrieval functions break CI pipeline</span>

<span class="sd">        &gt;&gt;&gt; df, _ = dataretrieval.nwis.get_dv(</span>
<span class="sd">        ...     &quot;03586500&quot;, parameterCd=&quot;00060&quot;,</span>
<span class="sd">        ...     start=&quot;2000-01-01&quot;, end=&quot;2003-01-05&quot;)</span>
<span class="sd">        &gt;&gt;&gt; data = utils.filter_data_by_time(df, 1, &#39;00060_Mean&#39;)</span>
<span class="sd">        &gt;&gt;&gt; data.shape</span>
<span class="sd">        (4,)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make date column the index if it is not already</span>
    <span class="k">if</span> <span class="n">date_column_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">date_column_name</span><span class="p">)</span>
    <span class="c1"># check that time_interval is valid</span>
    <span class="k">if</span> <span class="n">time_interval</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;time_interval must be one of &quot;day&quot;, &quot;month&quot;, or &quot;year&quot;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">time_interval</span> <span class="o">==</span> <span class="s1">&#39;day&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">leading_values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">trailing_values</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="c1"># grab data from the specified day of year</span>
            <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">==</span> <span class="n">value</span><span class="p">,</span> <span class="n">data_column_name</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># grab data from the specified day of year and include leading</span>
            <span class="c1"># and trailing values.</span>
            <span class="c1"># note that at the beginning and end of the year, this section</span>
            <span class="c1"># wraps backward and forward, respectively, to ensure it is</span>
            <span class="c1"># calculating percentiles from a full window.</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">leading_values</span><span class="p">):</span>
                <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">&gt;=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">leading_values</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">trailing_values</span><span class="p">)</span> <span class="o">|</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">&gt;=</span> <span class="mi">366</span> <span class="o">-</span> <span class="p">(</span><span class="n">leading_values</span> <span class="o">-</span> <span class="n">value</span><span class="p">)),</span>
                    <span class="n">data_column_name</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">value</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">366</span> <span class="o">-</span> <span class="n">trailing_values</span><span class="p">):</span>
                <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">&gt;=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">leading_values</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">trailing_values</span><span class="p">)</span> <span class="o">|</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">&lt;=</span> <span class="n">trailing_values</span> <span class="o">-</span> <span class="p">(</span><span class="mi">366</span> <span class="o">-</span> <span class="n">value</span><span class="p">)),</span>
                    <span class="n">data_column_name</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">&gt;=</span> <span class="n">value</span> <span class="o">-</span> <span class="n">leading_values</span><span class="p">)</span> <span class="o">&amp;</span>
                    <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span> <span class="o">&lt;=</span> <span class="n">value</span> <span class="o">+</span> <span class="n">trailing_values</span><span class="p">),</span>
                    <span class="n">data_column_name</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">time_interval</span> <span class="o">==</span> <span class="s1">&#39;month&#39;</span><span class="p">:</span>
        <span class="c1"># grab data from the specified month</span>
        <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">value</span><span class="p">,</span> <span class="n">data_column_name</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">time_interval</span> <span class="o">==</span> <span class="s1">&#39;year&#39;</span><span class="p">:</span>
        <span class="c1"># grab data from the specified year</span>
        <span class="n">dff</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">value</span><span class="p">,</span> <span class="n">data_column_name</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">drop_na</span><span class="p">:</span>
        <span class="n">dff</span> <span class="o">=</span> <span class="n">dff</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    <span class="c1"># return data as a pandas Series where the index is the date</span>
    <span class="k">return</span> <span class="n">dff</span></div>



<div class="viewcode-block" id="calculate_metadata">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.calculate_metadata">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Calculate metadata for a series of data.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data : pandas.Series</span>
<span class="sd">        The data to calculate the metadata for. Expected to have a datetime</span>
<span class="sd">        index.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The calculated metadata which includes the number of years of data,</span>
<span class="sd">        the number of data points, any gaps in the data, and the start and end</span>
<span class="sd">        dates of the data, the number of 0 values, the number of NA values,</span>
<span class="sd">        as well as the number of low (typically low flow &lt;= 0.01) values.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># initialize the metadata dictionary</span>
    <span class="n">meta</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># calculate the number of unique years of data</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;n_years&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span>
    <span class="c1"># calculate the number of data points that are not nan</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;n_data&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">data</span><span class="o">.</span><span class="n">isna</span><span class="p">()])</span>
    <span class="c1"># calculate the number of gaps in the data - missing years</span>
    <span class="n">expected_years</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;n_missing_years&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">expected_years</span> <span class="o">-</span> <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;n_years&quot;</span><span class="p">]</span>
    <span class="c1"># calculate the start and end dates of the data</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;start_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;end_date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="c1"># calculate the number of 0 values</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;n_zeros&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1"># calculate the number of nan values</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;n_nans&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span><span class="o">.</span><span class="n">isna</span><span class="p">()])</span>
    <span class="c1"># calculate the number of low values (below 0.01)</span>
    <span class="n">meta</span><span class="p">[</span><span class="s2">&quot;n_lows&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">data</span> <span class="o">&lt;=</span> <span class="mf">0.01</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">meta</span></div>



<div class="viewcode-block" id="define_year_doy_columns">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.define_year_doy_columns">[docs]</a>
<span class="k">def</span> <span class="nf">define_year_doy_columns</span><span class="p">(</span><span class="n">df_in</span><span class="p">,</span> <span class="n">date_column_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">year_type</span><span class="o">=</span><span class="s1">&#39;calendar&#39;</span><span class="p">,</span>
                            <span class="n">clip_leap_day</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to add year, day of year, and month-day columns to a DataFrame.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_in : pandas.DataFrame</span>
<span class="sd">        DataFrame containing data to filter. Expects datetime information to be</span>
<span class="sd">        available in the index or in a column named `date_column_name`.</span>

<span class="sd">    date_column_name : str, optional</span>
<span class="sd">        Name of column containing date information. If None, the index of</span>
<span class="sd">        `df` is used.</span>

<span class="sd">    year_type : str, optional</span>
<span class="sd">        The type of year to use. Must be one of &#39;calendar&#39;, &#39;water&#39;, or</span>
<span class="sd">        &#39;climate&#39;. Default is &#39;calendar&#39; which starts the year on January 1</span>
<span class="sd">        and ends on December 31. &#39;water&#39; starts the year on October 1 and</span>
<span class="sd">        ends on September 30 of the following year which is the &quot;water year&quot;.</span>
<span class="sd">        For example, October 1, 2010 to September 30, 2011 is &quot;water year</span>
<span class="sd">        2011&quot;. &#39;climate&#39; years begin on April 1 and end on March 31 of the</span>
<span class="sd">        following year, they are numbered by the ending year. For example,</span>
<span class="sd">        April 1, 2010 to March 31, 2011 is &quot;climate year 2011&quot;.</span>

<span class="sd">    clip_leap_day : bool, optional</span>
<span class="sd">        If True, February 29 is removed from the DataFrame. Default is False.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame with year, day of year, and month-day columns added. Also</span>
<span class="sd">        makes the date_column_name the index of the DataFrame.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># deep copy of the df before manipulating it</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df_in</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">deep</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># set the df index</span>
    <span class="k">if</span> <span class="n">date_column_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">date_column_name</span><span class="p">)</span>
    <span class="c1"># check that year_type is valid</span>
    <span class="k">if</span> <span class="n">year_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;calendar&#39;</span><span class="p">,</span> <span class="s1">&#39;water&#39;</span><span class="p">,</span> <span class="s1">&#39;climate&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="s1">&#39;year_type must be one of &quot;calendar&quot;, &quot;water&quot;, or &quot;climate&quot;.&#39;</span><span class="p">)</span>
    <span class="c1"># add year and day of year columns</span>
    <span class="k">if</span> <span class="n">year_type</span> <span class="o">==</span> <span class="s1">&#39;calendar&#39;</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;index_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span>
    <span class="k">elif</span> <span class="n">year_type</span> <span class="o">==</span> <span class="s1">&#39;water&#39;</span><span class="p">:</span>
        <span class="c1"># set water years</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;index_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span>
                                               <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># get calendar day of year</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span>
        <span class="c1"># adjust Oct 1 to be day 1 of water year for leap and non-leap years</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_leap_year</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">),</span>
               <span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">274</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_leap_year</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">10</span><span class="p">),</span>
               <span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">273</span>
        <span class="c1"># adjust Jan 1 accordingly for leap and non-leap years</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">,</span> <span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">92</span>
    <span class="k">elif</span> <span class="n">year_type</span> <span class="o">==</span> <span class="s1">&#39;climate&#39;</span><span class="p">:</span>
        <span class="c1"># set climate years</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;index_year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">,</span>
                                               <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">year</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
        <span class="c1"># get calendar day of year</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">dayofyear</span>
        <span class="c1"># adjust Apr 1 to be day 1 of climate year for leap and non-leap years</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_leap_year</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">),</span>
               <span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">91</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_leap_year</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;=</span> <span class="mi">4</span><span class="p">),</span>
               <span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">90</span>
        <span class="c1"># adjust Jan 1 to be day 276 of climate year for all years</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">,</span> <span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">275</span>
    <span class="c1"># add month and day columns</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;index_month_day&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># clip leap year and adjustment</span>
    <span class="k">if</span> <span class="n">clip_leap_day</span><span class="p">:</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">leap_year_adjustment</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">year_type</span><span class="o">=</span><span class="n">year_type</span><span class="p">)</span>
    <span class="c1"># sort the df by year and day of year</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">sort_values</span><span class="p">([</span><span class="s1">&#39;index_year&#39;</span><span class="p">,</span> <span class="s1">&#39;index_doy&#39;</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="leap_year_adjustment">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.leap_year_adjustment">[docs]</a>
<span class="k">def</span> <span class="nf">leap_year_adjustment</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">year_type</span><span class="o">=</span><span class="s1">&#39;calendar&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to adjust leap year days in a DataFrame.</span>

<span class="sd">    Adjust for a leap year by removing February 29 from the DataFrame and</span>
<span class="sd">    adjusting the day of year values for the remaining days of the year.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing data to adjust. Expects datetime information to be</span>
<span class="sd">        available in the index and a column named &#39;doy&#39; containing day of year.</span>

<span class="sd">    year_type : str, optional</span>
<span class="sd">        The type of year to use. Must be one of &#39;calendar&#39;, &#39;water&#39;, or</span>
<span class="sd">        &#39;climate&#39;. Default is &#39;calendar&#39; which starts the year on January 1</span>
<span class="sd">        and ends on December 31. &#39;water&#39; starts the year on October 1 and</span>
<span class="sd">        ends on September 30 of the following year which is the &quot;water year&quot;.</span>
<span class="sd">        For example, October 1, 2010 to September 30, 2011 is &quot;water year</span>
<span class="sd">        2011&quot;. &#39;climate&#39; years begin on April 1 and end on March 31 of the</span>
<span class="sd">        following year, they are numbered by the ending year. For example,</span>
<span class="sd">        April 1, 2010 to March 31, 2011 is &quot;climate year 2011&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame with leap year days removed and day of year values adjusted.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="o">~</span><span class="p">((</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="mi">29</span><span class="p">))]</span>
    <span class="k">if</span> <span class="n">year_type</span> <span class="o">==</span> <span class="s1">&#39;calendar&#39;</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_leap_year</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">),</span>
               <span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">year_type</span> <span class="o">==</span> <span class="s1">&#39;water&#39;</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_leap_year</span> <span class="o">&amp;</span>
               <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span>
               <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">),</span> <span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">elif</span> <span class="n">year_type</span> <span class="o">==</span> <span class="s1">&#39;climate&#39;</span><span class="p">:</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">is_leap_year</span> <span class="o">&amp;</span>
               <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">)</span> <span class="o">&amp;</span>
               <span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">month</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">),</span> <span class="s1">&#39;index_doy&#39;</span><span class="p">]</span> <span class="o">-=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="munge_nwis_stats">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.munge_nwis_stats">[docs]</a>
<span class="k">def</span> <span class="nf">munge_nwis_stats</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">source_pct_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_pct_col</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">year_type</span><span class="o">=</span><span class="s1">&#39;calendar&#39;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to munge and reformat NWIS statistics data.</span>

<span class="sd">    This is a utility function that exists to help munge NWIS percentile data</span>
<span class="sd">    served via the NWIS statistics web service. This function is intended to</span>
<span class="sd">    be used on Python dataretrieval dataframe returns for the nwis.get_stats()</span>
<span class="sd">    function for &quot;daily&quot; data, a single site, and a single parameter code.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing NWIS statistics data retrieved from the statistics</span>
<span class="sd">        web service. Assumed to come in as a dataframe retrieved with a</span>
<span class="sd">        package like dataretrieval or similar.</span>
<span class="sd">    source_pct_col : list, optional</span>
<span class="sd">        List of column names to use as the source percentiles. If None, the</span>
<span class="sd">        values are assumed to correspond to the 0, 5, 10, 25, 75, 90, 95,</span>
<span class="sd">        and 100 percentiles in the NWIS statistics service return.</span>
<span class="sd">    target_pct_col : list, optional</span>
<span class="sd">        List of column names to use as the target percentiles. If None, then</span>
<span class="sd">        integer values are used as the column names corresponding to the</span>
<span class="sd">        default source values.</span>
<span class="sd">    year_type : str, optional</span>
<span class="sd">        The type of year to use. Must be one of &#39;calendar&#39;, &#39;water&#39;, or</span>
<span class="sd">        &#39;climate&#39;. Default is &#39;calendar&#39; which starts the year on January 1</span>
<span class="sd">        and ends on December 31. &#39;water&#39; starts the year on October 1 and</span>
<span class="sd">        ends on September 30 of the following year which is the &quot;water year&quot;.</span>
<span class="sd">        For example, October 1, 2010 to September 30, 2011 is &quot;water year</span>
<span class="sd">        2011&quot;. &#39;climate&#39; years begin on April 1 and end on March 31 of the</span>
<span class="sd">        following year, they are numbered by the ending year. For example,</span>
<span class="sd">        April 1, 2010 to March 31, 2011 is &quot;climate year 2011&quot;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_slim : pandas.DataFrame</span>
<span class="sd">        DataFrame containing munged and reformatted NWIS statistics data.</span>
<span class="sd">        Reformatting is for use with the hyswap package plotting function for</span>
<span class="sd">        duration hydrographs with statistical information in background of</span>
<span class="sd">        the plot.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Get some NWIS statistics data.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; df, md = dataretrieval.nwis.get_stats(</span>
<span class="sd">        ...     &quot;03586500&quot;, parameterCd=&quot;00060&quot;, statReportType=&quot;daily&quot;)</span>

<span class="sd">    Then apply the function to munge the data.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; df = utils.munge_nwis_stats(df)</span>
<span class="sd">        &gt;&gt;&gt; df.shape</span>
<span class="sd">        (366, 8)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># set defaults</span>
    <span class="k">if</span> <span class="n">source_pct_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">source_pct_col</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;min_va&#39;</span><span class="p">,</span> <span class="s1">&#39;p05_va&#39;</span><span class="p">,</span> <span class="s1">&#39;p10_va&#39;</span><span class="p">,</span> <span class="s1">&#39;p25_va&#39;</span><span class="p">,</span>
                          <span class="s1">&#39;p75_va&#39;</span><span class="p">,</span> <span class="s1">&#39;p90_va&#39;</span><span class="p">,</span> <span class="s1">&#39;p95_va&#39;</span><span class="p">,</span> <span class="s1">&#39;max_va&#39;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">target_pct_col</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target_pct_col</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">100</span><span class="p">]</span>
    <span class="c1"># check lengths of lists for column names</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">source_pct_col</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">target_pct_col</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;source_pct_col and target_pct_col must be the same &#39;</span>
                         <span class="s1">&#39;length&#39;</span><span class="p">)</span>
    <span class="c1"># rename date columns</span>
    <span class="n">df</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;month_nu&#39;</span><span class="p">:</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;day_nu&#39;</span><span class="p">:</span> <span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;end_yr&#39;</span><span class="p">:</span> <span class="s1">&#39;year&#39;</span><span class="p">},</span>
              <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="c1"># make end year 2020 for leap year</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;year&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2020</span>
    <span class="c1"># construct date column</span>
    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">df</span><span class="p">[[</span><span class="s1">&#39;day&#39;</span><span class="p">,</span> <span class="s1">&#39;month&#39;</span><span class="p">,</span> <span class="s1">&#39;year&#39;</span><span class="p">]])</span>
    <span class="c1"># set doy_index and month-day as multi-index</span>
    <span class="n">month_day</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">doy_index</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;date&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">dayofyear</span>
    <span class="k">if</span> <span class="n">year_type</span> <span class="o">==</span> <span class="s1">&#39;water&#39;</span><span class="p">:</span>
        <span class="n">doy_index</span> <span class="o">=</span> <span class="n">doy_index</span> <span class="o">-</span> <span class="mi">273</span>
        <span class="n">doy_index</span><span class="p">[</span><span class="n">doy_index</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">365</span>
    <span class="k">elif</span> <span class="n">year_type</span> <span class="o">==</span> <span class="s1">&#39;climate&#39;</span><span class="p">:</span>
        <span class="n">doy_index</span> <span class="o">=</span> <span class="n">doy_index</span> <span class="o">-</span> <span class="mi">90</span>
        <span class="n">doy_index</span><span class="p">[</span><span class="n">doy_index</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">365</span>
    <span class="n">df</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_arrays</span><span class="p">(</span>
        <span class="p">[</span><span class="n">doy_index</span><span class="p">,</span> <span class="n">month_day</span><span class="p">],</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;doy&#39;</span><span class="p">,</span> <span class="s1">&#39;month-day&#39;</span><span class="p">])</span>
    <span class="c1"># slim down to just the columns used for the plot</span>
    <span class="n">df_slim</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">source_pct_col</span><span class="p">]</span>
    <span class="c1"># rename columns</span>
    <span class="n">df_slim</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">target_pct_col</span>
    <span class="c1"># return the dataframe</span>
    <span class="k">return</span> <span class="n">df_slim</span></div>



<div class="viewcode-block" id="calculate_summary_statistics">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.calculate_summary_statistics">[docs]</a>
<span class="k">def</span> <span class="nf">calculate_summary_statistics</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">data_col</span><span class="o">=</span><span class="s2">&quot;00060_Mean&quot;</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate summary statistics for a site.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing daily values for the site. Expected to be from</span>
<span class="sd">        `dataretrieval.nwis.get_dv()`, or similar.</span>

<span class="sd">    data_col : str, optional</span>
<span class="sd">        Name of the column in the dv_df DataFrame that contains the data of</span>
<span class="sd">        interest. Default is &quot;00060_Mean&quot; which is the mean daily discharge</span>
<span class="sd">        column.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    summary_df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing summary statistics for the site.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Get some NWIS data and apply the function to get the summary statistics.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">        &gt;&gt;&gt; df, _ = dataretrieval.nwis.get_dv(</span>
<span class="sd">        ...     &quot;03586500&quot;, parameterCd=&quot;00060&quot;,</span>
<span class="sd">        ...     startDT=&quot;2010-01-01&quot;, endDT=&quot;2010-12-31&quot;)</span>
<span class="sd">        &gt;&gt;&gt; summary_df = utils.calculate_summary_statistics(df)</span>
<span class="sd">        &gt;&gt;&gt; summary_df.shape</span>
<span class="sd">        (8, 1)</span>
<span class="sd">        &gt;&gt;&gt; print(summary_df)</span>
<span class="sd">                    Summary Statistics</span>
<span class="sd">        Site number           03586500</span>
<span class="sd">        Begin date          2010-01-01</span>
<span class="sd">        End date            2010-12-31</span>
<span class="sd">        Count                      365</span>
<span class="sd">        Minimum                   2.48</span>
<span class="sd">        Mean                    207.43</span>
<span class="sd">        Median                    82.5</span>
<span class="sd">        Maximum                 3710.0</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># make dictionary</span>
    <span class="n">summary_dict</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="c1"># populate it</span>
    <span class="c1"># site number</span>
    <span class="n">summary_dict</span><span class="p">[</span><span class="s1">&#39;Site number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="s1">&#39;site_no&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">8</span><span class="p">)</span>
    <span class="c1"># dates</span>
    <span class="n">summary_dict</span><span class="p">[</span><span class="s1">&#39;Begin date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">min</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">summary_dict</span><span class="p">[</span><span class="s1">&#39;End date&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">&#39;%Y-%m-</span><span class="si">%d</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="c1"># count</span>
    <span class="n">summary_dict</span><span class="p">[</span><span class="s1">&#39;Count&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="c1"># minimum</span>
    <span class="n">summary_dict</span><span class="p">[</span><span class="s1">&#39;Minimum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
    <span class="c1"># mean</span>
    <span class="n">summary_dict</span><span class="p">[</span><span class="s1">&#39;Mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># median</span>
    <span class="n">summary_dict</span><span class="p">[</span><span class="s1">&#39;Median&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
    <span class="c1"># maximum</span>
    <span class="n">summary_dict</span><span class="p">[</span><span class="s1">&#39;Maximum&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>

    <span class="c1"># make dataframe</span>
    <span class="n">summary_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">summary_dict</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># transpose and set column name</span>
    <span class="n">summary_df</span> <span class="o">=</span> <span class="n">summary_df</span><span class="o">.</span><span class="n">T</span>
    <span class="n">summary_df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Summary Statistics&#39;</span><span class="p">]</span>

    <span class="c1"># return dataframe</span>
    <span class="k">return</span> <span class="n">summary_df</span></div>



<div class="viewcode-block" id="filter_to_common_time">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.filter_to_common_time">[docs]</a>
<span class="k">def</span> <span class="nf">filter_to_common_time</span><span class="p">(</span><span class="n">df_list</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter a list of dataframes to common times based on index.</span>

<span class="sd">    This function takes a list of dataframes and filters them to only include</span>
<span class="sd">    the common times based on the index of the dataframes. This is necessary</span>
<span class="sd">    before comparing the timeseries and calculating statistics between two or</span>
<span class="sd">    more timeseries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df_list : list</span>
<span class="sd">        List of pandas.DataFrame objects to filter to common times.</span>
<span class="sd">        DataFrames assumed to have date-time information in the index.</span>
<span class="sd">        Expect input to be the output from a function like</span>
<span class="sd">        dataretrieval.nwis.get_dv() or similar.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df_list : list</span>
<span class="sd">        List of pandas.DataFrame objects filtered to common times.</span>
<span class="sd">    n_obs : int</span>
<span class="sd">        Number of observations in the common time period.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Get some NWIS data.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">            &gt;&gt;&gt; df1, md1 = dataretrieval.nwis.get_dv(</span>
<span class="sd">            ...     &quot;03586500&quot;, parameterCd=&quot;00060&quot;,</span>
<span class="sd">            ...     start=&quot;2018-12-15&quot;, end=&quot;2019-01-07&quot;)</span>
<span class="sd">            &gt;&gt;&gt; df2, md2 = dataretrieval.nwis.get_dv(</span>
<span class="sd">            ...     &quot;01646500&quot;, parameterCd=&quot;00060&quot;,</span>
<span class="sd">            ...     start=&quot;2019-01-01&quot;, end=&quot;2019-01-14&quot;)</span>
<span class="sd">            &gt;&gt;&gt; type(df1)</span>
<span class="sd">            &lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;</span>
<span class="sd">            &gt;&gt;&gt; type(df2)</span>
<span class="sd">            &lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;</span>

<span class="sd">    Filter the dataframes to common times.</span>

<span class="sd">    .. doctest::</span>

<span class="sd">            &gt;&gt;&gt; df_list, n_obs = utils.filter_to_common_time([df1, df2])</span>
<span class="sd">            &gt;&gt;&gt; df_list[0].shape</span>
<span class="sd">            (7, 3)</span>
<span class="sd">            &gt;&gt;&gt; df_list[1].shape</span>
<span class="sd">            (7, 3)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get the common index</span>
    <span class="n">common_index</span> <span class="o">=</span> <span class="n">df_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
    <span class="k">for</span> <span class="n">df</span> <span class="ow">in</span> <span class="n">df_list</span><span class="p">:</span>
        <span class="n">common_index</span> <span class="o">=</span> <span class="n">common_index</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="n">df</span><span class="o">.</span><span class="n">index</span><span class="p">)</span>
    <span class="c1"># filter the dataframes to the common index</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">df</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">df_list</span><span class="p">):</span>
        <span class="n">df_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">common_index</span><span class="p">]</span>
    <span class="c1"># get the number of observations</span>
    <span class="n">n_obs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">common_index</span><span class="p">)</span>
    <span class="c1"># return the list of dataframes</span>
    <span class="k">return</span> <span class="n">df_list</span><span class="p">,</span> <span class="n">n_obs</span></div>



<div class="viewcode-block" id="set_data_type">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.set_data_type">[docs]</a>
<span class="k">def</span> <span class="nf">set_data_type</span><span class="p">(</span><span class="n">data_type</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to set the data type for rolling averages.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data_type : str</span>
<span class="sd">        The type of data. Must be one of &#39;daily&#39;, &#39;7-day&#39;, &#39;14-day&#39;, and</span>
<span class="sd">        &#39;28-day&#39;. If &#39;7-day&#39;, &#39;14-day&#39;, or &#39;28-day&#39; is</span>
<span class="sd">        specified, the data will be averaged over the specified period. NaN</span>
<span class="sd">        values will be used for any days that do not have data. If present,</span>
<span class="sd">        NaN values will result in NaN values for the entire period.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    data_type : str</span>
<span class="sd">        The formatted frequency string to be used with</span>
<span class="sd">        pandas.DataFrame.rolling to calculate the average over the correct</span>
<span class="sd">        temporal period.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;daily&#39;</span><span class="p">:</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;1D&#39;</span>
    <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;7-day&#39;</span><span class="p">:</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;7D&#39;</span>
    <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;14-day&#39;</span><span class="p">:</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;14D&#39;</span>
    <span class="k">elif</span> <span class="n">data_type</span> <span class="o">==</span> <span class="s1">&#39;28-day&#39;</span><span class="p">:</span>
        <span class="n">data_type</span> <span class="o">=</span> <span class="s1">&#39;28D&#39;</span>

    <span class="k">return</span> <span class="n">data_type</span></div>



<div class="viewcode-block" id="categorize_flows">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.categorize_flows">[docs]</a>
<span class="k">def</span> <span class="nf">categorize_flows</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">data_col</span><span class="p">,</span> <span class="n">schema_name</span><span class="o">=</span><span class="s1">&#39;NWD&#39;</span><span class="p">,</span> <span class="n">custom_schema</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function to categorize streamflows based on percentile ranges</span>

<span class="sd">    This function assigns a category to each streamflow observation for a</span>
<span class="sd">    single site by comparing the estimated percentile to a schema of percentile</span>
<span class="sd">    ranges and associated category labels</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame containing values for the site.</span>

<span class="sd">    data_col : str</span>
<span class="sd">        Name of the column in the DataFrame that contains the data of</span>
<span class="sd">        interest, in this case estimated streamflow percentile.</span>

<span class="sd">    schema_name : str, optional</span>
<span class="sd">        Name of the categorization schema that should be used to categorize</span>
<span class="sd">        streamflow. Default is &quot;NWD&quot; schema.</span>

<span class="sd">    custom_schema : dict, optional</span>
<span class="sd">        Python dictionary describing custom schema to use for categorizing</span>
<span class="sd">        streamflow based on percentiles. Required in dict is &#39;ranges&#39;, an array</span>
<span class="sd">        of percentile cut points and &#39;labels&#39;, a list of category labels that</span>
<span class="sd">        matches the number of bins represented by ranges. Optionally can</span>
<span class="sd">        include &#39;low_label&#39; and &#39;high_label&#39; which are category labels</span>
<span class="sd">        associated with the lowest and highest values in &#39;ranges&#39;,</span>
<span class="sd">        respectively. Additional optional keys include &#39;colors&#39;, &#39;low_color&#39;,</span>
<span class="sd">        and &#39;high_color&#39; which specify a color palette that can be accessed in</span>
<span class="sd">        user created plots and maps. Default is None.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    df : pandas.DataFrame</span>
<span class="sd">        DataFrame with flow_cat column added.</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Categorize streamflow based on calculated percentiles for streamflow</span>
<span class="sd">    records downloaded from NWIS.</span>

<span class="sd">    .. doctest::</span>
<span class="sd">        :skipif: True  # dataretrieval functions break CI pipeline</span>

<span class="sd">        &gt;&gt;&gt; data, _ = dataretrieval.nwis.get_dv(</span>
<span class="sd">        ...     &quot;04288000&quot;, parameterCd=&quot;00060&quot;,</span>
<span class="sd">        ...     start=&quot;1900-01-01&quot;, end=&quot;2021-12-31&quot;)</span>
<span class="sd">        &gt;&gt;&gt; pcts_df = percentiles.calculate_variable_percentile_thresholds_by_day(  # noqa: E501</span>
<span class="sd">        ...     data, &#39;00060_Mean&#39;,</span>
<span class="sd">        ...     percentiles=[0, 5, 10, 25, 75, 90, 95, 100],</span>
<span class="sd">        ...     method=&#39;linear&#39;)</span>
<span class="sd">        &gt;&gt;&gt; new_data, _ = dataretrieval.nwis.get_dv(</span>
<span class="sd">        ...     &quot;04288000&quot;, parameterCd=&quot;00060&quot;,</span>
<span class="sd">        ...     start=&quot;2022-05-01&quot;, end=&quot;2022-05-07&quot;)</span>
<span class="sd">        &gt;&gt;&gt; new_percentiles = percentiles.calculate_multiple_variable_percentiles_from_values(  # noqa: E501</span>
<span class="sd">        ...     new_data, &#39;00060_Mean&#39;, pcts_df)</span>
<span class="sd">        &gt;&gt;&gt; new_percentiles = utils.categorize_flows(new_percentiles,</span>
<span class="sd">        ...     &#39;est_pct&#39;, schema_name=&#39;NWD&#39;)</span>
<span class="sd">        &gt;&gt;&gt; new_percentiles[[&#39;est_pct&#39;, &#39;flow_cat&#39;]].values</span>
<span class="sd">        [[13.62, &#39;Below normal&#39;],</span>
<span class="sd">        [14.15, &#39;Below normal&#39;],</span>
<span class="sd">        [14.29, &#39;Below normal&#39;],</span>
<span class="sd">        [23.41, &#39;Below normal&#39;],</span>
<span class="sd">        [27.44, &#39;Normal&#39;],</span>
<span class="sd">        [16.2, &#39;Below normal&#39;],</span>
<span class="sd">        [12.81, &#39;Below normal&#39;]]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">custom_schema</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">retrieve_schema</span><span class="p">(</span><span class="n">schema_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="n">custom_schema</span>

    <span class="n">df</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">cut</span><span class="p">(</span><span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">],</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;ranges&#39;</span><span class="p">],</span>
                            <span class="n">labels</span><span class="o">=</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;labels&#39;</span><span class="p">],</span>
                            <span class="n">include_lowest</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">right</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="s2">&quot;low_label&quot;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;low_label&#39;</span><span class="p">])</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;ranges&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;low_label&#39;</span><span class="p">]</span>  <span class="c1"># noqa: E501</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">reorder_categories</span><span class="p">(</span>
            <span class="p">[</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;low_label&#39;</span><span class="p">]]</span> <span class="o">+</span>
            <span class="n">df</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">categories</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">if</span> <span class="s2">&quot;high_label&quot;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="n">df</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">cat</span><span class="o">.</span><span class="n">add_categories</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s1">&#39;high_label&#39;</span><span class="p">])</span>  <span class="c1"># noqa: E501</span>
        <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df</span><span class="p">[</span><span class="n">data_col</span><span class="p">]</span> <span class="o">==</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;ranges&#39;</span><span class="p">][</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="s1">&#39;flow_cat&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">schema</span><span class="p">[</span><span class="s1">&#39;high_label&#39;</span><span class="p">]</span>  <span class="c1"># noqa: E501</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="retrieve_schema">
<a class="viewcode-back" href="../../reference/index.html#hyswap.utils.retrieve_schema">[docs]</a>
<span class="k">def</span> <span class="nf">retrieve_schema</span><span class="p">(</span><span class="n">schema_name</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Function used to retrieve the flow range categories given a schema name</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    schema_name : str</span>
<span class="sd">        Name of the categorization schema that should be used to categorize</span>
<span class="sd">        streamflow. Available options are &#39;NWD&#39;, &#39;WaterWatch,</span>
<span class="sd">        &#39;WaterWatch_Drought&#39;, &#39;WaterWatch_Flood&#39;, &#39;WaterWatch_BrownBlue&#39;, and</span>
<span class="sd">        &#39;NIDIS_Drought&#39;.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    schema : dict</span>
<span class="sd">        dictionary of flow ranges, category labels, and color palette</span>

<span class="sd">    Examples</span>
<span class="sd">    --------</span>
<span class="sd">    Retrieve the categorization schema &#39;NWD&#39; to categorization flow similar to</span>
<span class="sd">    the USGS National Water Dashboard</span>

<span class="sd">    .. doctest::</span>
<span class="sd">        :skipif: True</span>

<span class="sd">        &gt;&gt;&gt; schema = utils.retrieve_schema(&#39;NWD&#39;)</span>
<span class="sd">        &gt;&gt;&gt; print(schema)</span>
<span class="sd">        {&#39;ranges&#39;: [0, 10, 25, 76, 90, 100],</span>
<span class="sd">        &#39;labels&#39;: [&#39;Much below normal&#39;, &#39;Below normal&#39;, &#39;Normal&#39;,</span>
<span class="sd">            &#39;Above normal&#39;, &#39;Much above normal&#39;],</span>
<span class="sd">        &#39;colors&#39;: [&#39;#b24249&#39;, &#39;#e8ac49&#39;, &#39;#44f24e&#39;, &#39;#5fd7d9&#39;, &#39;#2641f1&#39;],</span>
<span class="sd">        &#39;low_label&#39;: &#39;All-time low&#39;,</span>
<span class="sd">        &#39;low_color&#39;: &#39;#e82f3e&#39;,</span>
<span class="sd">        &#39;high_label&#39;: &#39;All-time high&#39;,</span>
<span class="sd">        &#39;high_color&#39;: &#39;#1f296b&#39;}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">schema_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;nwd&#39;</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ranges&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">76</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
                  <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Much below normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Below normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Normal&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Above normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Much above normal&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;colors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#b24249&#39;</span><span class="p">,</span> <span class="s1">&#39;#e8ac49&#39;</span><span class="p">,</span> <span class="s1">&#39;#44f24e&#39;</span><span class="p">,</span> <span class="s1">&#39;#5fd7d9&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;#2641f1&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;low_label&#39;</span><span class="p">:</span> <span class="s1">&#39;All-time low&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;low_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#e82f3e&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;high_label&#39;</span><span class="p">:</span> <span class="s1">&#39;All-time high&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;high_color&#39;</span><span class="p">:</span> <span class="s2">&quot;#1f296b&quot;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">schema_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;waterwatch&#39;</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ranges&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
                  <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Low&#39;</span><span class="p">,</span> <span class="s1">&#39;Much below normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Below normal&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Above normal&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Much above normal&#39;</span><span class="p">,</span> <span class="s1">&#39;High&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;colors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#af2327&#39;</span><span class="p">,</span> <span class="s1">&#39;#fda328&#39;</span><span class="p">,</span> <span class="s1">&#39;#29fd2f&#39;</span><span class="p">,</span> <span class="s1">&#39;#4aded0&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;#0b24fb&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;low_label&#39;</span><span class="p">:</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;low_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#fc0d1b&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;high_label&#39;</span><span class="p">:</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;high_color&#39;</span><span class="p">:</span> <span class="s2">&quot;#000000&quot;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">schema_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;waterwatch_drought&#39;</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ranges&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">],</span>
                  <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Severe hydrologic drought&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Moderate hydrologic drought&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Below normal&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;colors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#af2327&#39;</span><span class="p">,</span> <span class="s1">&#39;#fd9941&#39;</span><span class="p">,</span> <span class="s1">&#39;#fecb6e&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;low_label&#39;</span><span class="p">:</span> <span class="s1">&#39;Extreme hydrologic drought&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;low_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#fc0d1b&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">schema_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;waterwatch_flood&#39;</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ranges&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mi">99</span><span class="p">,</span> <span class="mi">101</span><span class="p">],</span>
                  <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;&lt;95%&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;95-98%&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;&gt;= 99%&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;colors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#ffffff&#39;</span><span class="p">,</span> <span class="s1">&#39;#4aded0&#39;</span><span class="p">,</span> <span class="s1">&#39;#0b24fb&#39;</span><span class="p">]}</span>
    <span class="k">elif</span> <span class="n">schema_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;waterwatch_brownblue&#39;</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ranges&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">100</span><span class="p">],</span>
                  <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Much below normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Below normal&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Above normal&#39;</span><span class="p">,</span> <span class="s1">&#39;Much above normal&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;colors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#dcb668&#39;</span><span class="p">,</span> <span class="s1">&#39;#ebd6ab&#39;</span><span class="p">,</span> <span class="s1">&#39;#e9e9e9&#39;</span><span class="p">,</span> <span class="s1">&#39;#aacee0&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;#5699c0&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;low_label&#39;</span><span class="p">:</span> <span class="s1">&#39;Low&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;low_color&#39;</span><span class="p">:</span> <span class="s1">&#39;#8f4f1f&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;high_label&#39;</span><span class="p">:</span> <span class="s1">&#39;High&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;high_color&#39;</span><span class="p">:</span> <span class="s2">&quot;#292f6b&quot;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">schema_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;nidis_drought&#39;</span><span class="p">:</span>
        <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;ranges&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">],</span>
                  <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;Exceptional drought&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Extreme drought&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Severe drought&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Moderate drought&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Abnormally dry&#39;</span><span class="p">],</span>
                  <span class="s1">&#39;colors&#39;</span><span class="p">:</span> <span class="p">[</span><span class="s1">&#39;#720206&#39;</span><span class="p">,</span> <span class="s1">&#39;#e30b17&#39;</span><span class="p">,</span> <span class="s1">&#39;#fda929&#39;</span><span class="p">,</span> <span class="s1">&#39;#fbd285&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;#fffd38&#39;</span><span class="p">]}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;no matching schema found for &#39;</span> <span class="o">+</span> <span class="n">schema_name</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">schema</span></div>

</pre></div>

            <div class="clearer"></div>
          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li class="nav-item nav-item-0"><a href="../../index.html">hyswap 0.1.dev1+gaae8745 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li>
        <li class="nav-item nav-item-this"><a href="">hyswap.utils</a></li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
    &#169; Copyright .
      Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    </div>
  </body>
</html>